## OTUS LINUX.PROFESSIONAL 2022-01 LOKTIONOV_AV PROJECT

### Тема: "Развёртывание web-проекта Wiki.js и сервисной инфраструктуры, используя ресурсы Yandex Cloud с помощью системы оркестрации Terraform и автоматизации на основе Ansible"

Репозиторий содержит следующие директории:
- TERRAFORM - Конфигурация инфраструктуры
- ANSIBLE - Автоматизация развертывания инфраструктуры
- FILES - ключи SSH и YC + различные руководства по проекту

---

### Предварительные требования:
1. SOFT VERSION:
    ПО         | Версия
    :---: | :---:
    TERRAFORM | `1.2.8`
    ANSIBLE | `2.13.3`
    PYTHON | `3.10.6`

2. SSH:
- >Ключи SSH: [SSH-KEYS](/FILES/SSH-KEYS.md) 
3. YANDEX CLOUD:
- Заводим аккаут на YANDEX CLOUD
- >Парметры YC: [YC-PARAM](/FILES/YANDEX-CLOUD-PARAMETERS.md) 
- >Сервисный аккаунт YC: [YC-SERV-ACC](FILES/YANDEX-CLOUD-SERVICE-ACC.md)
- >Сертификат и доменное имя: [SSL-DOMAIN](FILES/SSL-DOMAIN.md)
Если нет сертификата/доменного имени, тоданный пункт можно не выполнять, используя самоподписанный сертификат и динамический внешний адрес.
4. TERRAFORM
- Что бы была возможность инициализировать TERRAFORM без активного VPN соединения необходимо скопировать файл `/FILES/terraformrc` в домашнюю директорию вашего пользователя с переменованием в `.terraformrc`:
`cp FILES/terraformrc ~/.terraformrc`

---

### Используемое ПО
- В качестве web-проекта был выбран бесплатный wiki-движок Wiki.js, работающий на Node.js и написанный на JavaScript.
- В качестве хранилища данных для Wiki.js выбор остановился на системе управления базами данных PostgreSQL 14
- В качестве системы мониторинга был выбран Zabbix Server версии 6.2 и агенты мониторинга Zabbix Agent 2
- В качестве системы логирования был выбран стандартный Rsyslog
- В качестве системы резервного копирования были выбраны Rsync (резервное копирование файлов) и Pg_Basebackup (Резервное копирование PostgreSQL)
- В качестве Web-proxy был выбран Nginx
- В качестве VPN-сервиса для удаленного доступа был выбран OpenVPN

### Схема проекта

![SCHEME](/FILES/SCHEME.png)

### Инфраструктура проекта

  Виртуальный сервер | Назначение    | Внутренний IP-адрес
  :--: | -- | :--:
  VPN | Сервер OPENVPN | 10.10.10.5
  GATE | PROXY-сервер NGINX | 10.10.10.10
  MON | Сервер мониторинга ZABBIX | 10.10.10.20
  LOG | Сервер сбора и хранения LOG-файлов | 10.10.10.30
  BACKUP | Сервер резервного копирования | 10.10.10.40
  WEB | WEB-сервер | 10.10.10.50
  SQL01 | Сервер баз данных (MASTER) | 10.10.10.61
  SQL02 | Сервер баз данных (SLAVE) | 10.10.10.62

### Terraform
- Вся конфигурация разделена на отдельные модули - отдельный модуль для создания внутренней подсети и по отдельному модулю на каждый виртуальный сервер с полным описанием создаваемых ресурсов (RAM, CPU, SSD, HDD, NETWORK, ISO).
- После успешного деплоя инфраструктуры в Yandex Cloud на основе шаблона `inventory.tmpl` в директории `ansible/environments` формируется динамический inventory-файл с внешними IP-адресами для последующей работы ansible-playbook. Руками адреса добавлять не нужно. Взаимодействие между серверами осуществляется по внутренней адресации.

### Ansible 
- `configure-terraform` - Деплой инфраструктуры в Yandex Cloud с помощью Terraform
- `configure-os` - Первоначальная настройка всех серверов. Обновляются пакеты, устанавливается нужное время и тайм-зона, добавляются записи в файл /etc/hosts, устанавливаются необходимый минимум стандартного набора софта, конфигурируется ssh для записи лога sftp в отдельный файл.
- `configure-basebackup-backup-host` - Копирование bash-скриптов pg_basebackup сервисов PostgreSQL серверов MON и SQL на сервер резервного копирования и обновление планировщика cron.
- `configure-docker` - Установка репозитория и пакетов docker и docker-compose
- `configure-docker-nginx` - Копирование docker-compose файла Nginx, конфигурационных файлов proxy-хостов wiki и zabbix, копирование с внешнего ресурса wildcard сертификатов и запуск итогового контейнера
- `configure-docker-portainer` - Копирование docker-compose файла Portainer и запуск итогового контейнера
- `configure-docker-wiki` - Копирование docker-compose файла wiki.js и запуск итогового контейнера
- `configure-hdd` - Создание раздела на дополнительном диске, создание файловой системы, правка fstab и монтирование диска в директорию /opt
- `configure-phppgadmin` - Установка пакетов Apache2 и phpPgAdmin, копирование конфигурационных файлов Apache2 и phpPgAdmin, конфигурация и запуск Apache2
- `configure-postgresql-all` - Добавление реопзитория PostgreSQL, установка PostgreSQL, копирование конфигурационных файлов, первоначальная общая настройка
- `configure-postgresql-master` - Создание пользователя репликации, правка конфигурационных файлов, создание слота репликации
- `configure-postgresql-slave` - Правка конфигурационных файлов, удаление файлов PostgreSQL, первичный Pg_Basebackup данных с master-сервера
- `configure-postgresql-wiki-db` - Создание пользователя wiki и базы данных wiki для web-проекта
- `configure-psql-client-backup-host` - Добавление реопзитория PostgreSQL, установка клиента PostgreSQL
- `configure-rsync-backup-host` - Конфигурация клиент-серверного Rsync, копирование bash-скриптов резервного копирования, правка заданий cron
- `configure-rsync-web-host` - Копирование конфигурационного файла сервера Rsync, настройка сервера Rsync
- `configure-rsyslog-client` - Копирование конфигурационных файлов Rsyslog клиента, настройка клиента Rsyslog
- `configure-rsyslog-server` - Копирование конфигурационных файлов Rsyslog сервера, создание директории хранения лог-файлов, настройка сервера Rsyslog
- `configure-vpn` - Копирование с VPN сервера текстового файла openvpn_password.txt с первичными учетными данными для авторизации в локальную директорию проекта FILES
- `configure-zabbix-agent` - Подключение репозитория zabbix, установка zabbix-agent2, копирование конфигурационного файла zabbix-agent2 и запуск агента мониторинга
- `configure-zabbix-server` - Создание пользователя zabbix и базы данных zabbix, установка пакетов сервера zabbix, копирование конфигурационных файлов, наполнение базы данных zabbix из первичного дампа, запуск сервера мониторинга zabbix, создание группы хостов на zabbix сервере, удаление хоста Zabbix Server
- `configure-zabbix-interface` - Добавление всех хостов на сервер zabbix с необходимыми именами, адресами и шаблонами

---

### Подготовка к запуску проекта
1. Правим конфигруационные файлы:
- В файле `./terraform/terraform.tfvars` заменяем `<change_me>` данные на свои (отмечены ### в конце):
```
cloud_id         = "<change_me>"
folder_id        = "<change_me>"
subnet_id        = "<change_me>"
gate_public_ip   = "<change_me>"
```
- В файле `./ansible/environments/group_vagrs/all.yml` заменяем `<change_me>` данные на свои (отмечены ### в конце):
```
crt_url: <change_me> 
key_url: <change_me>
```
!!! _ На заметку
В случае использования самоподписанного сертификата (на примере доменного имени domain.com, но данное руководство справедливо и для wildcard-сертификатов, расположенных не на внешнем ресурсе):
>- Поместить файлы самоподписанного сертификата и ключа `domain.com.crt` и `domain.com.key` в дирректорию `/configure-docker-nginx/files`
>- Исправить названия сертификата и ключа на корректные в файле `../configure-docker-nginx/tasks/docker-nginx.yml`
>- Исправить названия сертификата и ключа на корректные в файлах `../configure-docker-nginx/files/wiki.conf` и `../configure-docker-nginx/files/zabbix.conf`
>- Значения параметров `crt_url` и `key_url` заменить на `./files/domain.com.crt` и `./files/domain.com.key` соответственно
2. Устанавливаем зависимости
- Что бы корректно отработала ansible-роль `configure-zabbix-interface` необходимо установить зависимости из ansible-galaxy, которые прописаны в файле `requirements.yml`. Переходим в директорию `ansible` и запускаем установку зависимостей:
```
ansible-galaxy install -r requirements.yml
```
3. Проверка работоспособности Terraform:
- Перейти в директорию `terraform`, запустить инициализацию и планирование:
```
terraform init
terraform plan
```

---

### Запуск проекта
- После проведения всех подготовительных работ и проверок необходимо перейти в директорию `ansible`
- Запустить выполнение ANSIBLE PLAYBOOK:
```
ansible-playbook playbooks/playbook.yml
```
Общее время развертывания и настройки инфраструктуры занимает примерно 20 минут.

!!! _ На заметку
> - На серверах GATE и WEB приложения NGINX, WIKI.JS и PORTAINER разворачиваются в DOCKER контейнерах
> - На сервере WEB разровачивается приложение phpPGAdmin локально, без использования DOCKER для демонстрации работоспособности резервного копирования

---

### Проверка проекта
- GATE:
    - https://wiki.domain.com - должен отобразиться интерфейс установки wiki.js (domain.com доменное имя для примера)
    - https://zabbix.domain.com (Логин/Пароль: Admin/zabbix) - должен отобразиться веб-интерфейс системы мониторинга zabbix (domain.com доменное имя для примера)
- VPN:
    - Проверить наличие в директории FILES файла `openvpn_password.txt` с учетными данными VPN сервера (Далее все пукнты взяты из официальной документации YANDEX CLOUD)
    - Для создания пользователя VPN зайти по адресу `https://<IP-адрес VPN>/admin/` используя логин `openvpn` и пароль из файла `openvpn_password.txt` (Актуальную ссылку так же можно использовать из этого файла)
    - Разверните вкладку `User management` и выберите пункт `User permissions`
    - В списке пользователей введите имя нового пользователя в поле `New Username`, например `otus`
    - Нажмите значок карандаша в столбце `More Settings` и в поле `Password` введите пароль нового пользователя
    - Нажмите кнопку `Save settings`
    - Нажмите кнопку `Update running server`
    - Если приложение `OpenVPN` установлено на ПК, то добавляем новое подключение путем прописывания адреса сервера `https://<IP-адрес VPN>/` или через файл конфигурации, который можно получить авторизовавшись по адресу `https://<IP-адрес VPN>/` с учетными данными `otus` и вашим паролем
    - Если приложение не установлено, выполняем предыдущий пункт но в обратном порядке: `Авторизовываемся - Скачиваем дистрибутив - Устанавливаем - Добавляем профиль через файл конфигурации или адрес`
    - Подключаемся к VPN
- LOG (Только с активным OpenVPN):
    - Авторизоваться по SSH на сервере:
      `ssh -i ~/.ssh/ubuntu ubuntu@10.10.10.30`
    - Перейти в директорию `/opt/RSYSLOG_SERVER/`
    - Проверить наличие директорий по имени хостов
- MON (Только с активным OpenVPN):
    - Проверить внутренний доступ к системе мониторинга по адресу http://10.10.10.20:8080
- BACKUP (Только с активным OpenVPN):
    - Авторизоваться по SSH на сервере:
      `ssh -i ~/.ssh/ubuntu ubuntu@10.10.10.40`
    - Перейти в директорию `/opt/`
    - Проверить наличие директорий для хранения резервных копий и их содержимое (Резервируются базы PostgreSQL с серверов 10.10.10.20 и 10.10.10.61, а так же директория /usr/share/phppgadmin с сервера 10.10.10.50)
- SQL (Только с активным OpenVPN):
    - Используя любой SQL-клиент (Например `PGAdmin 4`) подключиться к серверам `10.10.10.61` и `10.10.10.62` по порту `5432`, используя логин/пароль `postgres/postgres`
- WEB (Только с активным OpenVPN):
    - Проверить внутренний доступ к wiki.js адресу http://10.10.10.50:8080
    - Проверить внутренний доступ к portainer адресу http://10.10.10.50:9000, при первом входе потребуется придумать пароль
    -  Проверить внутренний доступ к phpPgAdmin адресу http://10.10.10.50, используя логин/пароль `postgres/postgres`

---
### Удаление проекта из Yandex Cloud
- Перейти в директорию `terraform`
- Удалить ВМ из YC:
`terraform destroy -auto-approve`
- Зайти в интерфейс YC
- Перейти в Virtual Private Cloud
- Удалить зарезервированный IP-адрес
